#!/bin/bash
  
#
# JWT auth plugin
# ---------------

logger -t "${0}" "Notice: Creating jenkins JWT configuration..."

line=/etc/device/services/app/jenkins

# read auth if present
authname=""
if test -f "$line/auth.d/name.txt"; then
  authname="$(head -n 1 $line/auth.d/name.txt)"
fi

if test -n "${authname}"; then

  cat > "jwt-auth.yaml" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.

jenkins:
  securityRealm:
    jwtAuth:
      headerName: Authorization
      userClaimName: sub
      groupsClaimName: groups
#      groupsClaimSeparator: "-"
      acceptedIssuer: apache
      acceptedAudience: jenkins
#      jwksUrl: http://jwks-host/.well-known/openid
      leewaySeconds: 3
      allowVerificationFailures: true
      emailClaimName: sub
#      fullNameClaim: name

EOF


install -m 644 "jwt-auth.yaml" "/var/lib/jenkins/device"

fi

