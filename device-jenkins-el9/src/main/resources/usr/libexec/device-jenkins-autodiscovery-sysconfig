#!/bin/bash

#
# /etc/sysconfig/jenkins
# ----------------------

logger -t "${0}" "Notice: Creating jenkins /etc/sysconfig/jenkins..."

if test ! -f "/etc/device/services/app/jenkins/path.txt"; then
  exit 0;
fi
path=$(head -n 1 "/etc/device/services/app/jenkins/path.txt")

prefer=""

if test -f "/etc/device/services/app/jenkins/protocol.txt"; then
  protocol="$(head -n 1 /etc/device/services/app/jenkins/protocol.txt)"
  if test "${protocol}" == "default"; then
    prefer=""
  elif test "${protocol}" == "prefer-ipv4"; then
    prefer="-Djava.net.preferIPv4Stack=true"
  elif test "${protocol}" == "prefer-ipv6"; then
    prefer="-Djava.net.preferIPv6Addresses=true"
  fi
fi

if test -f "/etc/device/system/proxy/http/name.txt"; then
  proxyhost="-Dhttp.proxyHost=$(head -n 1 /etc/device/system/proxy/http/name.txt)"
fi
if test -f "/etc/device/system/proxy/http/port.txt"; then
  proxyport="-Dhttp.proxyPort=$(head -n 1 /etc/device/system/proxy/http/port.txt)"
fi

cat > "jenkins" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

JAVA_HOME=/etc/alternatives/jre_17

JENKINS_PORT=-1
JENKINS_PREFIX=${path}
JENKINS_UNIX_DOMAIN_PATH=/var/run/jenkins/jenkins.socket

CASC_JENKINS_CONFIG=/var/lib/jenkins/device

JAVA_OPTS="${prefer} -Djava.awt.headless=true ${proxyhost} ${proxyport}"

EOF


install -m 644 "jenkins" "/etc/sysconfig/jenkins"


