#!/bin/bash
  
#
# Location configuration
# ----------------------

logger -t "${0}" "Notice: Creating jenkins location configuration..."

line=/etc/device/services/app/jenkins

# read in the path if present
path=""
if test -f "${line}/path.txt"; then
  path="$(head -n 1 ${line}/path.txt)"
fi
# empty path becomes a /
if test -z "${path}";then
  path="/"
fi

# read in the server-name if present
servername=""
if test -f "${line}/virtualhost.d/server-name.txt"; then
  servername="$(head -n 1 ${line}/virtualhost.d/server-name.txt)"
fi
# empty servername becomes hostname
if test -z "${servername}";then
  servername=$(hostname -f)
fi

# read in the tlsport if present
tlsport=""
if test -f "${line}/virtualhost.d/listen.d/tls-port.txt"; then
  tlsport="$(head -n 1 ${line}/virtualhost.d/listen.d/tls-port.txt)"
else
  rm -f "/var/lib/jenkins/device/location.yaml"
  exit 0;
fi
# empty tls-port becomes 443
if test -z "${tlsport}" -o "${tlsport}" = "443";then
  port=""
else
  port=":${tlsport}"
fi

address="jenkins@${servername}"

cat > "location.yaml" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.

unclassified:
  location:
    url: https://${servername}${port}${path}
    adminAddress: ${address}
EOF


install -m 644 "location.yaml" "/var/lib/jenkins/device"


